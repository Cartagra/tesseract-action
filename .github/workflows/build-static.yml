name: Build Full Static Tesseract

on: 
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04  # 使用 20.04 兼容性更好
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 安装 Linux 系统编译全静态所需的额外包
      - name: Install System Static Libs
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++

      - name: Export GitHub Actions Cache Env
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '7c11b72a6f810293d0ce234de126b99e9ab6fa7a'

      - name: Create Custom Static Triplet
        run: |
          mkdir -p triplets
          cat <<EOF > triplets/x64-linux-static.cmake
          set(VCPKG_TARGET_ARCHITECTURE x64)
          set(VCPKG_CRT_LINKAGE static)
          set(VCPKG_LIBRARY_LINKAGE static)
          set(VCPKG_CMAKE_SYSTEM_NAME Linux)
          # 强制 vcpkg 在测试环境下也使用静态链接
          set(VCPKG_LINKER_FLAGS "-static -static-libgcc -static-libstdc++")
          EOF

      - name: Install Dependencies
        run: |
          $VCPKG_ROOT/vcpkg install leptonica tesseract \
            --overlay-triplets=triplets \
            --triplet x64-linux-static

      - name: Checkout Tesseract Source
        uses: actions/checkout@v4
        with:
          repository: tesseract-ocr/tesseract
          path: tesseract-src
          ref: 5.3.4

      - name: Configure and Build
        run: |
          cmake -S tesseract-src -B build \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_OVERLAY_TRIPLETS=${{ github.workspace }}/triplets \
            -DVCPKG_TARGET_TRIPLET=x64-linux-static \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TRAINING_TOOLS=OFF \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/dist \
            -DCMAKE_EXE_LINKER_FLAGS="-static" # 核心：强制链接器尝试全静态

          cmake --build build --config Release --parallel $(nproc) --target install

      - name: Strip and Verify
        run: |
          BIN_PATH="${{ github.workspace }}/dist/bin/tesseract"
          if [ -f "$BIN_PATH" ]; then
            strip "$BIN_PATH"
            echo "--- 文件详情 ---"
            file "$BIN_PATH"
            echo "--- 依赖检查 (预期输出: not a dynamic executable) ---"
            ldd "$BIN_PATH" || echo "Check Passed: Binary is fully static!"
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tesseract-full-static-linux
          path: ${{ github.workspace }}/dist/bin/tesseract
