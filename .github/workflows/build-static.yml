name: Build Static Tesseract

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Restore/Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '7c11b72a6f810293d0ce234de126b99e9ab6fa7a'

      # 关键步骤：定义 vcpkg 缺失的 x64-linux-static 配置
      - name: Create Custom Static Triplet
        run: |
          mkdir -p ${{ github.workspace }}/custom-triplets
          cat <<EOF > ${{ github.workspace }}/custom-triplets/x64-linux-static.cmake
          set(VCPKG_TARGET_ARCHITECTURE x64)
          set(VCPKG_CRT_LINKAGE static)
          set(VCPKG_LIBRARY_LINKAGE static)
          set(VCPKG_CMAKE_SYSTEM_NAME Linux)
          EOF

      - name: Install Dependencies (Static)
        run: |
          # 使用 --overlay-triplets 告知 vcpkg 去哪里找自定义配置
          $VCPKG_ROOT/vcpkg install leptonica tesseract \
            --overlay-triplets=${{ github.workspace }}/custom-triplets \
            --triplet x64-linux-static

      - name: Checkout Tesseract Source
        uses: actions/checkout@v4
        with:
          repository: tesseract-ocr/tesseract
          path: tesseract-src
          ref: 5.3.4

      - name: Configure CMake
        run: |
          # 同样需要告诉 CMake 自定义 Triplet 的路径
          cmake -S tesseract-src -B build \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_OVERLAY_TRIPLETS=${{ github.workspace }}/custom-triplets \
            -DVCPKG_TARGET_TRIPLET=x64-linux-static \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TRAINING_TOOLS=OFF \
            -DSTATIC=ON

      - name: Build Tesseract
        run: cmake --build build --config Release --parallel $(nproc)

      - name: Verify Static Linking
        run: |
          ls -lh build/tesseract
          file build/tesseract
          # 检查是否还有动态链接库依赖
          ldd build/tesseract || echo "Confirmed: No dynamic dependencies or static binary"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tesseract-static-linux
          path: build/tesseract
