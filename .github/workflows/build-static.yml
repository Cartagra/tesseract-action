name: Build Static Tesseract

on: 
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      # 核心：启用 GitHub Actions 专用二进制缓存后端
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. 暴露 GitHub Actions 缓存 API 令牌给 vcpkg 使用
      - name: Export GitHub Actions Cache Env
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      # 2. 初始化 vcpkg
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '8f76037b52479e0009623e11f753df90f6797b10'

      # 3. 创建强制全静态链接的自定义 Triplet
      - name: Create Custom Static Triplet
        run: |
          mkdir -p triplets
          cat <<EOF > triplets/x64-linux-static.cmake
          set(VCPKG_TARGET_ARCHITECTURE x64)
          set(VCPKG_CRT_LINKAGE static)
          set(VCPKG_LIBRARY_LINKAGE static)
          set(VCPKG_CMAKE_SYSTEM_NAME Linux)
          EOF

      # 4. 安装依赖（每成功一个包，vcpkg 都会立即上传缓存）
      - name: Install Dependencies
        run: |
          $VCPKG_ROOT/vcpkg install leptonica tesseract \
            --overlay-triplets=triplets \
            --triplet x64-linux-static

      # 5. 拉取 Tesseract 源码
      - name: Checkout Tesseract Source
        uses: actions/checkout@v4
        with:
          repository: tesseract-ocr/tesseract
          path: tesseract-src
          ref: 5.3.4

      # 6. 配置与编译（使用 install 目标来固定输出路径）
      - name: Configure and Build
        run: |
          cmake -S tesseract-src -B build \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_OVERLAY_TRIPLETS=${{ github.workspace }}/triplets \
            -DVCPKG_TARGET_TRIPLET=x64-linux-static \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TRAINING_TOOLS=OFF \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/dist

          # 编译并执行安装指令
          cmake --build build --config Release --parallel $(nproc) --target install

      # 7. 验证静态链接情况
      - name: Verify Static Linking
        run: |
          # 定位安装后的文件
          BIN_PATH="${{ github.workspace }}/dist/bin/tesseract"
          
          if [ -f "$BIN_PATH" ]; then
            echo "Binary found at $BIN_PATH"
            ls -lh "$BIN_PATH"
            file "$BIN_PATH"
            # 检查 ldd 依赖，全静态程序通常会返回 'not a dynamic executable'
            ldd "$BIN_PATH" || echo "Static check passed: No dynamic dependencies found."
          else
            echo "Error: Binary not found at $BIN_PATH"
            find build -name tesseract -type f
            exit 1
          fi

      # 8. 上传最终产物
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tesseract-static-linux-x64
          path: ${{ github.workspace }}/dist/bin/tesseract
